# Video QA - Parallel Processing Architecture

## ğŸ¯ æ ¸å¿ƒæ”¹è¿›

### é—®é¢˜
ä¹‹å‰çš„æ¶æ„æ˜¯**ä¸²è¡Œå¤„ç†**ï¼Œå¯¼è‡´ï¼š
- æœç´¢60-120ç§’ â†’ å›ç­”30-90ç§’ = **æ€»å…±90-210ç§’**
- å¦‚æœæœç´¢è¶…æ—¶ï¼Œæ•´ä¸ªè¯·æ±‚å¤±è´¥
- ç”¨æˆ·å¿…é¡»ç­‰å¾…æ‰€æœ‰æ“ä½œå®Œæˆ

### è§£å†³æ–¹æ¡ˆ
æ–°æ¶æ„é‡‡ç”¨**å¹¶è¡Œå¤„ç† + å¤šå±‚fallback**ï¼š
- æœç´¢å’Œå›ç­”**åŒæ—¶å¼€å§‹**
- **ä¿è¯æœ‰ç­”æ¡ˆ**ï¼ˆå³ä½¿æœç´¢å¤±è´¥ï¼‰
- **15-30ç§’**å°±èƒ½å¾—åˆ°ç¬¬ä¸€ä¸ªç­”æ¡ˆ
- æœç´¢ç»“æœå¯é€‰åœ°å¢å¼ºç­”æ¡ˆ

## ğŸ—ï¸ æ–°æ¶æ„æµç¨‹

```
ç”¨æˆ·æé—®
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¹¶è¡Œå¤„ç† (t=0 åŒæ—¶å¯åŠ¨)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  çº¿ç¨‹1: æœç´¢ (60sè¶…æ—¶)                  â”‚  çº¿ç¨‹2: Fallback LLM (90sè¶…æ—¶)
â”‚  â”œâ”€ Embeddingæœç´¢                       â”‚  â”œâ”€ ç›´æ¥LLMè°ƒç”¨
â”‚  â”œâ”€ å‘é‡ç›¸ä¼¼åº¦                          â”‚  â”œâ”€ ä½¿ç”¨é€šç”¨çŸ¥è¯†
â”‚  â””â”€ è¿”å›ç»“æœæˆ–è¶…æ—¶                      â”‚  â””â”€ è¿”å›ç­”æ¡ˆ âœ“ (ä¿è¯æœ‰)
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                    â†“
    (å¯é€‰çš„)              (æ€»æ˜¯å‡†å¤‡å¥½)
         â†“                    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  å¢å¼º (30s)              â”‚
    â”‚  å¦‚æœæœç´¢æˆåŠŸï¼Œ          â”‚
    â”‚  ç»“åˆæœç´¢+fallback       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         æœ€ç»ˆç­”æ¡ˆ
    (åŒ…å«timingå…ƒæ•°æ®)
```

## â±ï¸ è¶…æ—¶å±‚çº§

```
æ€»è¯·æ±‚: 300s (maxDuration)
  â””â”€ QAæ“ä½œ: 270s
      â”œâ”€ å¹¶è¡Œ:
      â”‚   â”œâ”€ æœç´¢: 60s (åå°ï¼Œå¯é€‰)
      â”‚   â””â”€ Fallback LLM: 90s (å‰å°ï¼Œå¿…éœ€) âœ“
      â”œâ”€ å¿«é€Ÿæœç´¢ç­‰å¾…: 5s (fallbackå‡†å¤‡å¥½å)
      â”œâ”€ å¢å¼º: 30s (å¯é€‰ï¼Œå¦‚æœæœç´¢æˆåŠŸ)
      â””â”€ ç´§æ€¥: 20s (æœ€åæ‰‹æ®µ)
```

## ğŸ›¡ï¸ ä¸‰å±‚Fallbackç³»ç»Ÿ

```
ç¬¬1å±‚: å¢å¼ºç­”æ¡ˆ (æœç´¢ + LLM) - æœ€ä½³è´¨é‡
   â†“ (å¦‚æœæœç´¢è¶…æ—¶)
ç¬¬2å±‚: ç›´æ¥LLMç­”æ¡ˆ - è‰¯å¥½è´¨é‡ï¼Œå¿«é€Ÿ
   â†“ (å¦‚æœLLMå¤±è´¥)
ç¬¬3å±‚: ç´§æ€¥LLM - åŸºç¡€ç­”æ¡ˆï¼Œä¿è¯æœ‰
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¹‹å‰ (ä¸²è¡Œ):
```
æœç´¢ (60-120s) â†’ å›ç­” (30-90s) = 90-210s æ€»è®¡
âŒ å¦‚æœæœç´¢è¶…æ—¶ï¼Œæ•´ä¸ªè¯·æ±‚å¤±è´¥
âŒ ç”¨æˆ·ç­‰å¾…æ‰€æœ‰æ“ä½œ
```

### ç°åœ¨ (å¹¶è¡Œ):
```
æœç´¢ (60s) â•‘ Fallback (15-30s) = 15-30s å¾—åˆ°ç¬¬ä¸€ä¸ªç­”æ¡ˆ âœ“
           â•‘ å¢å¼º (5-30s) = 20-60s å¾—åˆ°æœ€ç»ˆç­”æ¡ˆ âœ“
âœ… æ€»æ˜¯å¿«é€Ÿå¾—åˆ°fallbackç­”æ¡ˆ
âœ… å¦‚æœå¯ç”¨ï¼Œç”¨æœç´¢ç»“æœå¢å¼º
```

### å…¸å‹å“åº”æ—¶é—´:
- **ç®€å•é—®é¢˜**: 10-20ç§’ (ä»…fallback)
- **æœ‰æœç´¢ç»“æœ**: 20-40ç§’ (fallback + å¢å¼º)
- **æœç´¢è¶…æ—¶**: 15-25ç§’ (ä»…fallbackï¼Œå¿½ç•¥æœç´¢)
- **å¤–éƒ¨è§†é¢‘**: 10-20ç§’ (ä¸éœ€è¦æœç´¢)
- **ç´§æ€¥fallback**: 5-10ç§’ (æœ€åæ‰‹æ®µ)

### ç“¶é¢ˆåˆ†æ (ä»æ—¥å¿—):
```
ğŸ“Š ç¤ºä¾‹timingåˆ†è§£:
{
  database: 150ms,           // âœ… å¿«
  fallback_total: 18000ms,   // âœ… å¯æ¥å— (18s)
  search: 65000ms,           // âš ï¸ æ…¢ä½†ä¸é˜»å¡
  enhancement: 8000ms,       // âœ… å¿«
  total: 26000ms             // âœ… å¾ˆå¥½! (26sæ€»è®¡)
}
```

## ğŸ” è¯¦ç»†æ—¥å¿—ç¤ºä¾‹

```
ğŸ¯ [1699123456789] Starting educationalQA: "ä»€ä¹ˆæ˜¯ç‰›é¡¿ç¬¬ä¸€å®šå¾‹..."
ğŸ“¹ [1699123456790] Video context: { lessonId: "abc", currentTime: 120 }
âš¡ [1699123456791] Starting parallel processing...
ğŸ” [1699123456792] Step 1: Starting search...
ğŸ¤– [1699123456793] Step 2: Starting fallback LLM answer...
ğŸ“¡ [1699123456850] LLM instance created, invoking...
âœ… [1699123471850] Fallback answer completed in 15057ms (LLM: 15000ms)
âœ… [1699123471851] Got fallback answer: 1234 chars
â° [1699123476851] Quick search timeout, using fallback only
ğŸ [1699123476852] Total time: 20061ms
ğŸ“Š Timings: {
  fallback_llm: 15000,
  fallback_total: 15057,
  search: 20000,
  total: 20061
}
âœ… [1699123476853] Returning fallback answer
```

## ğŸ’¡ å…³é”®ä»£ç ç‰‡æ®µ

### 1. å¹¶è¡Œå¯åŠ¨
```typescript
// åŒæ—¶å¯åŠ¨æœç´¢å’Œfallback
const searchPromise = (async () => {
  // æœç´¢é€»è¾‘ï¼Œ60sè¶…æ—¶
})();

const fallbackPromise = (async () => {
  // ç›´æ¥LLMè°ƒç”¨ï¼Œ90sè¶…æ—¶
  const llm = await getLLM({ model: "z-ai/glm-4.5-air:free" });
  return await llm.invoke(fallbackPrompt);
})();
```

### 2. ä¿è¯æœ‰ç­”æ¡ˆ
```typescript
// å…ˆç­‰å¾…fallback (ä¿è¯æœ‰ç­”æ¡ˆ)
const fallbackAnswer = await fallbackPromise;
console.log(`âœ… Got fallback answer: ${fallbackAnswer.length} chars`);

// ç„¶åå°è¯•è·å–æœç´¢ç»“æœ (å¯é€‰)
const quickSearchTimeout = new Promise((resolve) => 
  setTimeout(() => resolve(""), 5000) // åªç­‰5ç§’
);
const searchResults = await Promise.race([searchPromise, quickSearchTimeout]);
```

### 3. å¯é€‰å¢å¼º
```typescript
if (searchResults && !searchResults.includes("No relevant content found")) {
  // ç”¨æœç´¢ç»“æœå¢å¼ºç­”æ¡ˆ
  const enhanced = await enhanceWithSearch(fallbackAnswer, searchResults);
  return { answer: enhanced, confidence: 0.95 };
}

// è¿”å›fallbackç­”æ¡ˆ (æˆ‘ä»¬æ€»æ˜¯æœ‰è¿™ä¸ª)
return { answer: fallbackAnswer, confidence: 0.75 };
```

### 4. ç´§æ€¥fallback
```typescript
try {
  // ä¸»è¦é€»è¾‘
} catch (error) {
  // æœ€åæ‰‹æ®µ: ç®€å•ç›´æ¥ç­”æ¡ˆ
  const llm = await getLLM({ model: "z-ai/glm-4.5-air:free" });
  const emergencyAnswer = await llm.invoke(`Answer briefly: ${question}`);
  return { answer: emergencyAnswer.content, confidence: 0.6 };
}
```

## âœ… ä¼˜åŠ¿

1. âœ… **æ€»æ˜¯è¿”å›ç­”æ¡ˆ** - å³ä½¿æœç´¢å¤±è´¥ä¹Ÿä¿è¯æœ‰å“åº”
2. âœ… **æ›´å¿«å“åº”** - å…¸å‹å“åº”æ—¶é—´: 10-30s (vs ä¹‹å‰çš„60-120s)
3. âœ… **ä¸å†è¶…æ—¶** - å¹¶è¡Œå¤„ç†é˜²æ­¢ç“¶é¢ˆ
4. âœ… **æ›´å¥½è´¨é‡** - å¦‚æœå¯ç”¨ï¼Œç”¨æœç´¢ç»“æœå¢å¼º
5. âœ… **å®Œå…¨å¯è§‚æµ‹** - æ¯ä¸ªè¯·æ±‚çš„è¯¦ç»†timingæ•°æ®
6. âœ… **ä¼˜é›…é™çº§** - ä¸‰å±‚fallbackç³»ç»Ÿ
7. âœ… **æˆæœ¬æ•ˆç‡** - ä¸ç­‰å¾…æ…¢æ“ä½œ

## ğŸ§ª æµ‹è¯•å»ºè®®

1. **ç®€å•é—®é¢˜** - åº”è¯¥åœ¨10-20ç§’å†…å¾—åˆ°ç­”æ¡ˆ
2. **å¤æ‚é—®é¢˜** - åº”è¯¥åœ¨20-40ç§’å†…å¾—åˆ°å¢å¼ºç­”æ¡ˆ
3. **æœç´¢è¶…æ—¶åœºæ™¯** - åº”è¯¥ä»ç„¶åœ¨15-25ç§’å†…å¾—åˆ°fallbackç­”æ¡ˆ
4. **å®Œå…¨å¤±è´¥åœºæ™¯** - åº”è¯¥åœ¨5-10ç§’å†…å¾—åˆ°ç´§æ€¥ç­”æ¡ˆ
5. **ç›‘æ§æ—¥å¿—** - æ£€æŸ¥timingæ•°æ®è¯†åˆ«ç“¶é¢ˆ

## ğŸ”® æœªæ¥ä¼˜åŒ–

1. **æµå¼å“åº”** - å®æ—¶è¿”å›ç­”æ¡ˆç‰‡æ®µ
2. **ç¼“å­˜** - ç¼“å­˜å¸¸è§é—®é¢˜å’Œç­”æ¡ˆ
3. **æ›´å¿«çš„embedding** - è€ƒè™‘æ›´å¿«çš„embeddingæ¨¡å‹
4. **åå°å¤„ç†** - å°†é•¿æ“ä½œç§»åˆ°åå°ä½œä¸š
5. **è¾¹ç¼˜å‡½æ•°** - ç§»åˆ°edge runtimeé™ä½å»¶è¿Ÿ
6. **é¢„åŠ è½½** - é¢„æµ‹æ€§åœ°é¢„åŠ è½½å¸¸è§å†…å®¹
