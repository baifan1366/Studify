# 视频处理系统测试指南

## 概述

本文档详细介绍如何测试 Studify 平台的 QStash 视频处理系统。该系统包含视频上传、压缩、音频转换、Whisper 转录和 AI 嵌入生成等功能。

## 系统架构

### 处理流程
1. **视频上传** → 创建处理队列并初始化步骤
2. **视频压缩** → 通过 Cloudinary 优化视频
3. **音频转换** → 从压缩视频中提取音频
4. **Whisper 转录** → 将音频转换为文本（支持重试）
5. **嵌入生成** → 创建 AI 嵌入（支持服务器切换）
6. **完成通知** → 发送通知并更新数据库

## 环境准备

### 必需的环境变量

```env
# Hugging Face API 端点
BGE_HG_EMBEDDING_SERVER_API_URL=https://your-bge-server.com
E5_HG_EMBEDDING_SERVER_API_URL=https://your-e5-server.com
WHISPER_HG_VOICE_TO_TEXT_SERVER_API_URL=https://your-whisper-server.com

# QStash 配置
QSTASH_URL=https://qstash.upstash.io
QSTASH_TOKEN=your-qstash-token
QSTASH_CURRENT_SIGNING_KEY=your-current-key
QSTASH_NEXT_SIGNING_KEY=your-next-key

# MEGA 文件存储
MEGA_EMAIL=your-mega-email
MEGA_PASSWORD=your-mega-password

# OneSignal 通知
ONESIGNAL_REST_API_KEY=your-onesignal-key

# 基础 URL
NEXTAUTH_URL=https://your-domain.com
```

### 数据库表检查

确保以下数据库表存在：
- `video_processing_queue` - 主处理队列
- `video_processing_steps` - 处理步骤状态
- `video_processing_queue_status` - 状态查询视图

## 测试方法

### 1. 自动化测试脚本

运行系统自检脚本：

```bash
npx ts-node scripts/test-video-processing.ts
```

该脚本会检查：
- ✅ 数据库表结构
- ✅ 环境变量配置
- ✅ QStash 连接
- ✅ Hugging Face 端点可用性
- ✅ 通知系统配置

### 2. 手动功能测试

#### 2.1 视频上传测试

**步骤：**
1. 登录为导师角色
2. 进入课程管理页面
3. 点击"存储"按钮
4. 上传一个测试视频文件（建议 < 50MB）
5. 观察是否自动开始处理

**预期结果：**
- 文件成功上传
- 自动弹出处理进度对话框
- 显示"视频压缩"步骤开始

#### 2.2 处理进度监控测试

**步骤：**
1. 在处理进度对话框中观察状态变化
2. 检查进度百分比更新
3. 验证步骤名称显示正确

**预期结果：**
- 进度条实时更新
- 步骤按顺序显示：压缩 → 音频转换 → 转录 → 嵌入
- 百分比从 0% 逐步增加到 100%

#### 2.3 取消功能测试

**步骤：**
1. 在处理过程中点击"取消处理"
2. 确认取消操作
3. 检查处理状态

**预期结果：**
- 处理立即停止
- 状态更新为"已取消"
- 收到取消通知

#### 2.4 通知系统测试

**步骤：**
1. 完成一次完整的视频处理
2. 检查浏览器通知
3. 查看应用内通知

**预期结果：**
- 处理开始时收到通知
- 处理完成时收到通知
- 如果失败，收到错误通知

### 3. 错误处理测试

#### 3.1 服务器休眠测试

**模拟场景：**
- Hugging Face 服务器处于休眠状态

**测试方法：**
1. 暂时断开网络或使用无效的 API 端点
2. 上传视频进行处理
3. 观察重试机制

**预期结果：**
- 系统自动检测服务器休眠
- 每分钟重试一次，最多 3 次
- 显示重试状态和次数

#### 3.2 网络错误测试

**测试方法：**
1. 在处理过程中断开网络
2. 观察错误处理

**预期结果：**
- 显示网络错误信息
- 提供重试选项
- 不会丢失处理进度

### 4. API 端点测试

#### 4.1 使用 Postman 或 curl 测试

**开始处理：**
```bash
curl -X POST "http://localhost:3000/api/video-processing/upload" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"attachment_id": 123}'
```

**查询状态：**
```bash
curl -X GET "http://localhost:3000/api/video-processing/status/QUEUE_ID" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**取消处理：**
```bash
curl -X DELETE "http://localhost:3000/api/video-processing/status/QUEUE_ID" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 5. 性能测试

#### 5.1 并发处理测试

**测试方法：**
1. 同时上传多个视频文件
2. 观察系统性能
3. 检查队列管理

**预期结果：**
- 每个视频独立处理
- 不会相互干扰
- 队列按顺序处理

#### 5.2 大文件测试

**测试方法：**
1. 上传较大的视频文件（接近 100MB 限制）
2. 监控处理时间
3. 检查内存使用

**预期结果：**
- 成功处理大文件
- 合理的处理时间
- 稳定的内存使用

## 测试用例清单

### ✅ 基础功能测试
- [ ] 视频上传成功
- [ ] 处理队列创建
- [ ] 步骤状态更新
- [ ] 进度百分比显示
- [ ] 完成通知发送

### ✅ 错误处理测试
- [ ] 服务器休眠重试
- [ ] 网络错误处理
- [ ] 文件格式验证
- [ ] 大小限制检查
- [ ] 权限验证

### ✅ 用户体验测试
- [ ] 进度条实时更新
- [ ] 取消功能正常
- [ ] 通知及时准确
- [ ] 错误信息清晰
- [ ] 界面响应流畅

### ✅ 集成测试
- [ ] OneSignal 通知
- [ ] 数据库一致性
- [ ] QStash 队列管理
- [ ] Cloudinary 集成
- [ ] MEGA 存储

## 常见问题排查

### 问题 1：处理卡在某个步骤
**可能原因：**
- Hugging Face 服务器休眠
- 网络连接问题
- API 密钥过期

**解决方法：**
1. 检查服务器状态
2. 验证网络连接
3. 更新 API 密钥
4. 手动重试处理

### 问题 2：通知未收到
**可能原因：**
- OneSignal 配置错误
- 用户未授权通知
- 浏览器阻止通知

**解决方法：**
1. 检查 OneSignal 配置
2. 确认通知权限
3. 检查浏览器设置

### 问题 3：处理失败
**可能原因：**
- 文件格式不支持
- 文件损坏
- 服务器错误

**解决方法：**
1. 验证文件格式
2. 尝试其他文件
3. 检查服务器日志

## 测试数据

### 推荐测试文件

**小文件测试（< 10MB）：**
- 短视频片段
- 简单录屏
- 基础功能验证

**中等文件测试（10-50MB）：**
- 教学视频
- 演示录像
- 性能测试

**大文件测试（50-100MB）：**
- 完整课程视频
- 高清录制
- 压力测试

### 测试账户

确保有以下角色的测试账户：
- **导师账户**：用于上传和管理视频
- **学生账户**：用于查看处理结果
- **管理员账户**：用于系统监控

## 监控和日志

### 关键日志位置
- QStash 处理日志
- 数据库操作日志
- API 请求日志
- 错误和异常日志

### 监控指标
- 处理成功率
- 平均处理时间
- 重试次数
- 错误类型分布

## 部署前检查

### 生产环境测试
1. ✅ 所有环境变量正确配置
2. ✅ 数据库迁移完成
3. ✅ 外部服务连接正常
4. ✅ 通知系统工作正常
5. ✅ 错误处理机制有效

### 性能验证
1. ✅ 响应时间在可接受范围
2. ✅ 并发处理能力满足需求
3. ✅ 内存使用稳定
4. ✅ 错误恢复机制有效

## 总结

视频处理系统采用现代化的异步架构，具备完善的错误处理和用户体验。通过系统化的测试，可以确保系统在各种场景下都能稳定运行，为用户提供优质的视频处理服务。

定期执行这些测试用例，可以及早发现问题并保持系统的高可用性。
